<!DOCTYPE html>
<!--
Copyright (c) 2015 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/model/counter.html">
<link rel="import" href="/model/counter_series.html">
<link rel="import" href="/model/model.html">
<link rel="import" href="/model/kernel.html">

<script>
'use strict';

tr.b.unittest.testSuite(function() {

  var Counter = tr.model.Counter;
  var CounterSeries = tr.model.CounterSeries;
  var Device = tr.model.Device;
  var Model = tr.Model;

  test('updateBounds', function() {
    var device = new Device(new Model());
    
    // Verify that the bounds match the lowest and highest counters
    var ctr1 = device.getOrCreateCounter('cat', 'ctr1');
    var series1 = new CounterSeries('a', 0);
    ctr1.addSeries(series1);
    series1.addCounterSample(100, 5);
    series1.addCounterSample(200, 5);
    
    var ctr2 = device.getOrCreateCounter('cat', 'ctr2');
    var series2 = new CounterSeries('b', 0);
    ctr2.addSeries(series2);
    series2.addCounterSample(400, 5);
    
    device.updateBounds();
    
    assert.equal(device.bounds.min, 100);
    assert.equal(device.bounds.max, 400);
    
    // Add a new value and verify that the bounds change
    series2.addCounterSample(700, 5);
    
    device.updateBounds();
    
    assert.equal(device.bounds.max, 700);
 });

  test('shiftTimestampsForward', function() {
    var device = new Device(new Model());
    
    var ctr1 = device.getOrCreateCounter('cat', 'ctr1');
    var series1 = new CounterSeries('a', 0);
    ctr1.addSeries(series1);
    series1.addCounterSample(100, 5);
    series1.addCounterSample(200, 5);
    
    // Add a second counter to verify that all counters are shifted
    var ctr2 = device.getOrCreateCounter('cat', 'ctr2');
    var series2 = new CounterSeries('b', 0);
    ctr2.addSeries(series2);
    series2.addCounterSample(300, 5);
    
    device.shiftTimestampsForward(5);
    
    assert.equal(ctr1.series[0].samples[0].timestamp, 105);
    assert.equal(ctr1.series[0].samples[1].timestamp, 205);
    assert.equal(ctr2.series[0].samples[0].timestamp, 305);
  });

  test('addCategoriesToDict', function() {
    var device = new Device(new Model());
    var ctr1 = device.getOrCreateCounter('cat1', 'name1');
    var ctr2 = device.getOrCreateCounter('cat1', 'name2');
    var ctr3 = device.getOrCreateCounter('cat2', 'name1');

    var expectedDict = {
      'cat1': true,
      'cat2': true
    };

    var actualDict = {};
    device.addCategoriesToDict(actualDict);
    assert.deepEqual(actualDict, expectedDict);
  });

  test('iterateAllChildEventContainers', function() {
    var device = new Device(new Model());
    var ctr1 = device.getOrCreateCounter('cat1', 'name1');
    var ctr2 = device.getOrCreateCounter('cat1', 'name2');
    var ctr3 = device.getOrCreateCounter('cat2', 'name1');

    var expectedIds = ['cat1.name1', 'cat1.name2', 'cat2.name1'];

    var actualIds = [];
    device.iterateAllChildEventContainers(function(child) {
      actualIds.push(child.id);
    });

    assert.deepEqual(actualIds, expectedIds);
  });

  test('getOrCreateCounter', function() {
    var device = new Device(new Model());
    var ctr1 = device.getOrCreateCounter('cat1', 'name1');
    var ctr2 = device.getOrCreateCounter('cat1', 'name2');
    var ctr3 = device.getOrCreateCounter('cat2', 'name1');

    var expected = {
      'cat1.name1': ctr1,
      'cat1.name2': ctr2,
      'cat2.name1': ctr3
    };
    assert.deepEqual(device.counters, expected);
  });
});
</script>

